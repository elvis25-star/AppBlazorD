@inject LibroService libroService
@inject NavigationManager navigationManager
<EditForm Model="@oLibroFormCLS" OnValidSubmit="@guardar">
	<DataAnnotationsValidator/>
	<div class="mt-3">
		<label>Id Libro</label>
		<InputNumber readonly class="form-control" @bind-Value="oLibroFormCLS.idlibro"/>

	</div>
	<div class="mt-3">
		<label>Titulo</label>
		<InputText class="form-control" @bind-Value="oLibroFormCLS.titulo" />
		<ValidationMessage For="(()=>oLibroFormCLS.titulo)" />
	</div>
	<div class="mt-3">
		<label>Resumen</label>
		<InputTextArea class="form-control" @bind-Value="oLibroFormCLS.resumen" />
		<ValidationMessage For="(() => oLibroFormCLS.resumen)" />
	</div>
	<div class="mt-3">
		<label>Tipo de libro</label>
		<InputSelect class="form-control" @bind-Value="oLibroFormCLS.tipoLibro">
			<option value="">--Seleccione--</option>
			<option value="Cuento">Cuento</option>
			<option value="Novela">Novela</option>
			<option value="Leyenda">Leyenda</option>
		</InputSelect>
		<ValidationMessage For="(() => oLibroFormCLS.tipoLibro)" />
	</div>
	<div class="mt-3">
		<img src="@imagePreview" alt="Image Preview" width="150" height="150" style="border:1px solid"/>
	</div>
	<div class="mt-3">
		<InputFile OnChange="HandleSelected" accept="image/*"></InputFile>
	</div>
	<div class="mt-3">
		<button type="submit" class="btn btn-success">Guardar</button>
		<button class="btn btn-danger" @onclick="regresar">Regresar</button>
	</div>
</EditForm>
@code {
	[Parameter] public int? idlibro{ get; set; }

	public LibroFormCLS oLibroFormCLS { get; set; } = new LibroFormCLS();

	protected override void OnInitialized()
	{
		if (idlibro != null)
		{
			oLibroFormCLS = libroService.obtenerLibro(idlibro.Value);
		}
		else
		{
			oLibroFormCLS.idlibro = libroService.ObtenerSiguienteId();
		}
	}

	private void guardar()
	{
		//Console.WriteLine("Guardando");
		if (idlibro == null)
		{
			libroService.agregarLibro(oLibroFormCLS);
		}
		else
		{
			libroService.actualizarLibro(oLibroFormCLS);
		}
		navigationManager.NavigateTo("/libro");
	}
	private void regresar()
	{
		navigationManager.NavigateTo("/libro");
	}
	private string? imagePreview = "/img/nophoto.jpg";
	private async Task HandleSelected(InputFileChangeEventArgs e)
	{
		var file = e.File;
		if (file != null)
		{
			var buffer = new byte[file.Size];
			await file.OpenReadStream().ReadAsync(buffer);
			imagePreview = $"data: {file.ContentType};base64,{Convert.ToBase64String(buffer)}";
		}
	}
}